<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="org.pms.dataService.dao.ReviewBatchProjectDao">
    <select id="getRelationByIdAndProjectId" resultType="org.pms.dataService.content.ReviewBatchProject">
        SELECT
            rbp.*
        FROM
            review_batch_project_relation rbpr
            INNER JOIN review_batch_project rbp ON rbp.id = rbpr.reviewBatchProjectId
            AND rbp.projectId = #{projectId}
        WHERE
            rbpr.reviewBatchId = #{reviewBatchId}
    </select>
    <select id="getRelationByProjectId" resultType="org.pms.dataService.content.ReviewBatchProject">
        select * from review_batch_project where projectId = #{projectId}
    </select>

    <update id="update" parameterType="ReviewBatchProject">
        update review_batch_project
        <set>
            <if test="progress != null and progress != ''">
                progress = #{progress},
            </if>
            <if test="result != null and result != ''">
                result = #{result},
            </if>
            <if test="conclusion != null">
                conclusion = #{conclusion},
            </if>
            <if test="message != null and message != ''">
                message = #{message},
            </if>
            <if test="state != null">
                state = #{state},
            </if>
        </set>
        <where>
            id = #{id}
        </where>
    </update>

    <update id="updateProjectType">
        update review_batch_project
        <set>
            <if test="transferType != null">
                transferType = #{transferType},
            </if>
            <if test="transferId != null">
                transferId = #{transferId},
            </if>
        </set>
        <where>
            projectId = #{projectId}
        </where>
    </update>

    <select id="getApprovalProject" parameterType="java.lang.Integer" resultType="java.lang.Integer">
        SELECT
            COUNT(1)
        FROM
            review_batch_project rbp
            INNER JOIN review_batch_project_relation rbpr ON rbpr.reviewBatchProjectId = rbp.id
            AND rbpr.reviewBatchId = #{reviewBatchId}
        WHERE
            rbp.conclusion = 2
            AND rbp.state = 0
    </select>

</mapper>