<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="org.pms.dataService.dao.EPersonDictDao">
   <select id="query" parameterType="java.util.Map" resultMap="EPersonDict">
      select * from epersondict
      <trim prefix="where" prefixOverrides="AND|OR">
        <if test="epersonId != null">
          and epersonId = #{epersonId}
        </if>
        <if test="name != null">
          and name = #{name}
        </if>
        <if test="id!=null and id!=0">
         and eperson_dict_id=#{id}
        </if>
      </trim>
   </select>




   <select id="queryCommDict" parameterType="java.util.Map" resultMap="EPersonCommDict">
      select * from eperson_comm_dict
      <trim prefix="where" prefixOverrides="AND|OR">
        <if test="epersonId != null">
          and epersonId = #{epersonId}
        </if>
        <if test="name != null">
          and name = #{name}
        </if>
      </trim>
   </select>
   
   <select id="blurryMatchAuthor" parameterType="java.lang.String" resultType="java.lang.String">
      SELECT DISTINCT(ed.username) FROM epersondict ed, eperson e
      <if test="comm.length() > 0">
        ,eperson_comm_dict ecd
      </if>
      <trim prefix="WHERE" prefixOverrides="AND|OR">
        AND e.`visible` >= 0
        <if test="comm.length() > 0">
          AND e.epersonId = ecd.epersonId and ed.epersonId = ecd.epersonId AND trim(#{comm,jdbcType=VARCHAR}) like concat('%', ecd.name, '%')
        </if>
        AND e.epersonId = ed.epersonId AND ed.name = trim(#{author,jdbcType=VARCHAR})
      </trim>
   </select>


   <update id="batchUpdate">
     update epersondict ed, eperson e set ed.epersonId = e.epersonId
        where ed.sys_code is not null and ed.epersonId is null and e.sys_code = ed.sys_code
   </update>


   <update id="batchUpdateCommDict">
     update eperson_comm_dict ecd, eperson e set ecd.epersonId = e.epersonId
        where ecd.eperson_syscode is not null and ecd.epersonId is null and e.sys_code = ecd.eperson_syscode
   </update>
   
   <select id="queryName" resultType="java.lang.String" parameterType="java.util.Map">
     SELECT NAME FROM epersondict
      <trim prefix="where" prefixOverrides="AND|OR">
         <choose>
            <when test="flag !=null and flag == 'en_US'">
               and NAME LIKE CONCAT(#{term},'%')
            </when>
            <when test="flag !=null and flag == 'zh_CN'">
               and NAME LIKE CONCAT('%',#{term},'%')
            </when>
         </choose>
         <if test="epersonId != null">
            and epersonId = #{epersonId}
         </if>
      </trim>
        <if test="flag !=null and flag == 'en_US'">limit 0,30</if>
   </select>
</mapper>